<script>
  function fallbackImage(img) {
    if (!img.src) return;
    var formats = ['jpg', 'png', 'jpeg', 'svg', 'webp'];
    var src = img.src;
    var lastDotIndex = src.lastIndexOf('.');
    
    // 如果没有后缀名，或者是一个数据 URI，就不处理
    if (lastDotIndex === -1 || src.indexOf('data:') === 0) return;
    
    // 提取当前后缀，忽略 URL 参数 (?version=...)
    var currentExt = src.substring(lastDotIndex + 1).split('?')[0].toLowerCase();
    
    if (!img.dataset.tried) {
      img.dataset.tried = currentExt;
    }
    
    var tried = img.dataset.tried.split(',');
    
    // 查找下一个未尝试的格式 (兼容性更好的写法)
    var nextFormat = null;
    for (var i = 0; i < formats.length; i++) {
      if (tried.indexOf(formats[i]) === -1) {
        nextFormat = formats[i];
        break;
      }
    }
    
    if (nextFormat) {
      img.dataset.tried += ',' + nextFormat;
      // 构造新 URL
      var newSrc = src.substring(0, lastDotIndex) + '.' + nextFormat;
      // 如果原 URL 有参数（如 ?v=1），可以在这里补上，但为了简单起见通常不需要
      img.src = newSrc;
      // console.log('Image load failed, retrying with:', nextFormat);
    } else {
      // 所有格式都试过了，彻底失败
      img.onerror = null; 
      img.style.opacity = '0.5'; 
      img.alt = 'Image not found';
    }
  }
</script>

<div class="clearfix gutter-spacious">
  {% for event in site.data.learning_events.events %}
  <div class="col-md-4 float-left animate-in mb-4">
    <h3 class="alt-h3 mb-3">{{ event.title }}</h3>
    <p><a href="{{ event.url | default: '#' }}" target="_blank">
      <img src="{{ event.image | relative_url }}" class="img-fluid animate-in" alt="{{ event.alt }}" onerror="fallbackImage(this)"/></a>
    </p>
    <p class="text-gray">{{ event.description }}</p>
    <details>
      <summary class="btn btn-sm btn-outline toggle-arrow">Show Outputs</summary>
      <ul class="mt-2">
        {% for output in event.outputs %}
        <li>{{ output.flag }} <strong>{{ output.country }}</strong>: <a href="{{ output.url }}" target="_blank">{{ output.title }}</a></li>
        {% endfor %}
      </ul>
    </details>
    {% if event.links %}
      <p class="mt-2"><strong>Related Links:</strong></p>
      <ul class="mt-1">
        {% for link in event.links %}
          <li><a href="{{ link.url }}" target="_blank">{{ link.title }}</a></li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
  {% endfor %}
</div>
